<div th:fragment="content" class="admin-dashboard">
  <!-- Fragmento: página de administração. Contém secções: 'Utilizadores por aprovar' e 'Gestão de Anúncios'. -->
  <h2>Administração</h2>

  <!-- Utilizadores por aprovar -->
  <!-- Lista de utilizadores pendentes; o botão 'Aprovar' envia um POST com token CSRF. A ação é restrita a admins. -->
  <div class="card user-approve-card">
    <h3>Utilizadores por aprovar</h3>
    <div th:if="${#lists.isEmpty(pendingUsers)}" class="muted">Sem pedidos de aprovação.</div>
    <div th:unless="${#lists.isEmpty(pendingUsers)}" class="ads-table-wrapper">
      <table class="ads-table">
        <thead>
          <tr><th>Username</th><th>E-mail</th><th>Ações</th></tr>
        </thead>
        <tbody>
          <tr th:each="u : ${pendingUsers}">
            <td th:text="${u.username}"></td>
            <td th:text="${u.email}"></td>
            <td class="actions-cell">
              <form th:action="@{'/admin/users/' + ${u.id} + '/approve'}" method="post" style="display:inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn-primary">Aprovar</button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Gestão de Anúncios -->
  <section class="manage-ads">
    <h3>Gestão de Anúncios</h3>

    <!-- Barra de pesquisa -->
    <!-- Filtros: 'type' e 'state' usam enums do domínio via Thymeleaf (T(...)). -->
    <form method="get" action="/admin" class="filters-bar">
      <div class="filters-row">
        <div class="filter">
          <label>Tipo</label>
          <select name="type">
            <option th:value="${null}" th:selected="${type == null}">Todos os tipos</option>
            <option th:value="${T(roomrent.model.Ad.AdType).OFERTA}" th:selected="${type?.name() == 'OFERTA'}">Ofertas</option>
            <option th:value="${T(roomrent.model.Ad.AdType).PROCURA}" th:selected="${type?.name() == 'PROCURA'}">Procura</option>
          </select>
        </div>
        <div class="filter">
          <label>Estado</label>
          <select name="state">
            <option th:value="${null}" th:selected="${state == null}">Todos os estados</option>
            <option th:value="${T(roomrent.model.Ad.State).ATIVO}" th:selected="${state?.name() == 'ATIVO'}">Ativo</option>
            <option th:value="${T(roomrent.model.Ad.State).INATIVO}" th:selected="${state?.name() == 'INATIVO'}">Inativo</option>
          </select>
        </div>
        <div class="filter">
          <label>Zona</label>
          <input name="zone" type="text" th:value="${zone}" placeholder="Ex.: Évora">
        </div>
        <div class="filter">
          <label>Anunciante</label>
          <input name="name" type="text" th:value="${name}" placeholder="Nome do anunciante">
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Pesquisar</button>
        </div>
      </div>
    </form>

    <!-- Tabela de resultados -->
    <!-- Resultados: iteramos `ads.content` (obj Page). -->
    <div class="ads-table-wrapper">
      <table class="ads-table">
        <thead>
          <tr><th>Código</th><th>Tipo</th><th>Anunciante</th><th>Zona</th><th>Preço</th><th>Estado</th><th>Ações</th></tr>
        </thead>
        <tbody>
          <tr th:each="ad : ${ads.content}">
            <td th:text="${ad.code}"></td>
            <td th:text="${ad.type}"></td>
            <td th:text="${ad.advertiserName}"></td>
            <td th:text="${ad.zone}"></td>
            <td><strong th:text="${ad.price} + ' €'"></strong></td>
            <td>
              <!-- Badge visual indica estado do anúncio (Ativo/Inativo). -->
              <span class="badge" th:classappend="${ad.state == T(roomrent.model.Ad.State).ATIVO} ? 'badge-active' : 'badge-inactive'"
                    th:text="${ad.state == T(roomrent.model.Ad.State).ATIVO} ? 'Ativo' : 'Inativo'"></span>
            </td>
            <td class="actions-cell">
              <!-- Ações (Ativar/Inativar/Apagar/Ver detalhes). 
               Cada ação (excepto 'Ver detalhes') é um formulário POST protegido com CSRF e confirmação JS para evitar ações acidentais. 
               'Apagar' é irreversível. -->
              <form th:if="${ad.state.name() == 'INATIVO'}" th:action="@{'/admin/ads/' + ${ad.id} + '/activate'}" method="post" style="display:inline"
                    onsubmit="return confirm('Tem a certeza que pretende ativar este anúncio?');">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn-primary">Ativar</button>
              </form>
              <form th:if="${ad.state.name() == 'ATIVO'}" th:action="@{'/admin/ads/' + ${ad.id} + '/deactivate'}" method="post" style="display:inline"
                    onsubmit="return confirm('Tem a certeza que pretende inativar este anúncio?');">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn-warning">Inativar</button>
              </form>
              <form th:action="@{'/admin/ads/' + ${ad.id} + '/delete'}" method="post" style="display:inline"
                    onsubmit="return confirm('Tem a certeza que pretende apagar permanentemente este anúncio? Esta ação não pode ser revertida.');">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn-danger">Apagar</button>
              </form>
              <a th:href="@{'/ads/' + ${ad.id}}" class="btn-secondary">Ver detalhes</a>
            </td>
          </tr>
        </tbody>
      </table>
      <p th:if="${ads.empty}" class="muted">Nenhum anúncio encontrado.</p>
    </div>

    
  </section>
</div>
